<!DOCTYPE html>
<html>
    <head>
        <title>1.åœ°å›³ã‚¿ã‚¤ãƒ«ã‚’èƒŒæ™¯ã¨ã—ã¦è¡¨ç¤ºã™ã‚‹</title>
        <!-- Leafletã®CSSèª­ã¿è¾¼ã¿ -->
        <link
            rel="stylesheet"
            href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css"
            integrity="sha512-xodZBNTC5n17Xt2atTPuE1HxjVMSvLVW9ocqUKLsCC5CXdbqCmblAshOMAS6/keqq/sMZMZ19scR4PsZChSR7A=="
            crossorigin=""
        />
        <!-- Leafletã®JavaScriptèª­ã¿è¾¼ã¿ -->
        <script
            src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"
            integrity="sha512-XQoYMqMTK8LvdxXYG3nZ448hOEQiglfqkJs1NOQV44cWnUrBc8PkAOcXy20w0vlaXaVUearIOBhiXZ5V3ynxwA=="
            crossorigin=""
        ></script>
    </head>
    <body>
        <!-- åœ°å›³ã‚’è¡¨ç¤ºã™ã‚‹divè¦ç´ ã‚’å®£è¨€ -->
        <div id="map" style="height: 80vh"></div>
        <script>
            // åœ°å›³ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã‚’åˆæœŸåŒ–
            const map = L.map('map', {
                center: [34.547026,135.505008], // åˆæœŸè¡¨ç¤ºã®åœ°å›³ä¸­å¿ƒã®[ç·¯åº¦, çµŒåº¦]
                zoom: 18, // åˆæœŸã‚ºãƒ¼ãƒ ãƒ¬ãƒ™ãƒ«
            });
            // èƒŒæ™¯ãƒ¬ã‚¤ãƒ¤ãƒ¼ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã‚’åˆæœŸåŒ–
            const backgroundLayer = L.tileLayer(
                'https://tile.openstreetmap.org/{z}/{x}/{y}.png', // OSMã®URLãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆ
                {
                    maxZoom: 19,
                    attribution:
                        '&copy; <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors',
                },
            );
            // åœ°å›³ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã¸ãƒ¬ã‚¤ãƒ¤ãƒ¼ã‚’è¿½åŠ 
            map.addLayer(backgroundLayer);

            // èƒŒæ™¯ãƒ¬ã‚¤ãƒ¤ãƒ¼ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã‚’åˆæœŸåŒ–
            const chiriinLayer = L.tileLayer(
                 'https://cyberjapandata.gsi.go.jp/xyz/std/{z}/{x}/{y}.png',  // åœ°ç†é™¢åœ°å›³ã®URLãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆ
                  {
                        maxZoom: 18
                  },
            );
            // åœ°ç†é™¢åœ°å›³ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã¸ãƒ¬ã‚¤ãƒ¤ãƒ¼ã‚’è¿½åŠ 
            map.addLayer(chiriinLayer);

            var LayerControl = L.control.layers({
                "OpenStreetMap": backgroundLayer,
                "åœ°ç†é™¢åœ°å›³ï¼ˆæ¨™æº–ï¼‰": chiriinLayer
            }).addTo(map);

            // ãƒ­ãƒ¼ã‚«ãƒ«PCä¸Šã®OSRMã‚µãƒ¼ãƒã§æ‰æœ¬ã‚­ãƒ£ãƒ³ãƒ‘ã‚¹ã‹ã‚‰ãªã‹ã‚‚ãšã‚­ãƒ£ãƒ³ãƒ‘ã‚¹ã¾ã§ã®ãƒ«ãƒ¼ãƒˆã‚’æ¤œç´¢ã™ã‚‹URL
            const url = 'https://routing.openstreetmap.de/routed-car/route/v1/driving/135.505276,34.592331;135.506274,34.544865?geometries=geojson&overview=full'

            async function addRouteLayer(){
                const response = await fetch(url);
                const json = await response.json();
                routeLayer = L.geoJSON(json['routes'][0]['geometry'],{
                    "color": "#FF00FF",
                    "weight": 6,
                    "opacity": 0.65
                });                            
                routeLayer.addTo(map);
      
                // åœ°å›³ã‚’ãƒ«ãƒ¼ãƒˆã«åˆã†ã‚ˆã†ã«èª¿æ•´
                const bounds = routeLayer.getBounds();
                map.fitBounds(bounds); 
      
            }
            // åœ°å›³ã«ãƒ«ãƒ¼ãƒˆã‚’è¿½åŠ 
            addRouteLayer();

            /* â–¼â–¼â–¼ GeoJSONãƒ•ã‚¡ã‚¤ãƒ«ã®ãƒ‘ã‚¹ â–¼â–¼â–¼ */
            const shelterGeojsonURL = '27100_1.geojson';

            const shelterLayer = L.layerGroup();

            async function loadShelters(){
                const response = await fetch(shelterGeojsonURL);   // GeoJSONèª­è¾¼
                const geojson = await response.json();             // JSONå¤‰æ›

                const geojsonLayer = L.geoJSON(geojson, {

                    // Point â†’ Markerå¤‰æ›
                    pointToLayer: function(feature, latlng){
                        return L.marker(latlng);
                    },

                    // å„Featureã®å‡¦ç†ï¼ˆãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—ãªã©ï¼‰
                    onEachFeature: function(feature, layer){
                        const p = feature.properties;

                        layer.bindPopup(`
                            <b>${p["æ–½è¨­ãƒ»å ´æ‰€å"]}</b><br>
                            ä½æ‰€ï¼š${p["ä½æ‰€"]}<br>
                            å…±é€šIDï¼š${p["å…±é€šID"]}<br>
                            å‚™è€ƒï¼š${p["å‚™è€ƒ"] || "ãªã—"}
                        `);
                    }

                });

                shelterLayer.addLayer(geojsonLayer);  // ãƒ¬ã‚¤ãƒ¤ãƒ¼ã«ã¾ã¨ã‚ã‚‹
                shelterLayer.addTo(map);              // ãƒãƒƒãƒ—ã«è¿½åŠ 
            }

            // å®Ÿè¡Œ
            loadShelters();

ã€€ã€€ã€€ã€€ã€€ã€€ /* =========================
                 å‡¡ä¾‹ï¼ˆãƒ¬ã‚¸ã‚§ãƒ³ãƒ‰ï¼‰
            ========================= */

            const legend = L.control({ position: 'bottomright' });

            legend.onAdd = function (map) {
                const div = L.DomUtil.create('div', 'legend-box');

                div.innerHTML = `
                   <div style="
                      background: white;
                      padding: 10px 14px;
                      border-radius: 8px;
                      box-shadow: 0 0 6px rgba(0,0,0,0.3);
                      font-size: 14px;
                      line-height: 1.6;
                   ">
                      <b>å‡¡ä¾‹</b><br>
                      <span style="font-size:18px;">ğŸ”µ</span> é¿é›£æ‰€
                    </div>
                 `;

                 return div;
            };

            legend.addTo(map);


            //ã‚¹ã‚±ãƒ¼ãƒ«ãƒãƒ¼
            L.control.scale().addTo(map);
        </script>
    </body>
</html>
